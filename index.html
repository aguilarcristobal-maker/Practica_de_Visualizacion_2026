<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mortalidad y Esperanza de Vida - Comunitat Valenciana 2010-2023</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #1e3a5f;
            --secondary: #2d5a87;
            --accent: #f59e0b;
            --danger: #dc2626;
            --success: #16a34a;
            --hombre: #3b82f6;
            --mujer: #ec4899;
            --ambos: #8b5cf6;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, #1e4d6b 100%);
            color: white; padding: 2rem 1.5rem; text-align: center; position: relative; overflow: hidden;
        }
        .header::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5;
        }
        .header-content { position: relative; z-index: 1; }
        .header h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 0.3rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .header .subtitle { font-size: 1rem; opacity: 0.9; margin-bottom: 0.8rem; }
        .header-meta { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
        .header .badge { display: inline-block; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white; padding: 0.4rem 1rem; border-radius: 50px; font-weight: 500; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.3); }
        .badge.accent { background: var(--accent); color: var(--primary); border: none; }
        .nav { background: var(--card); padding: 0.8rem 1rem; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .nav-container { max-width: 1400px; margin: 0 auto; display: flex; gap: 0.4rem; flex-wrap: wrap; justify-content: center; }
        .nav-btn { padding: 0.5rem 1rem; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.85rem; font-weight: 500; color: var(--text-light); transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; }
        .nav-btn:hover { background: var(--bg); color: var(--text); }
        .nav-btn.active { background: var(--primary); color: white; }
        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card); border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        .card-title { font-size: 1.1rem; font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        .card-subtitle { font-size: 0.8rem; color: var(--text-light); margin-top: 0.2rem; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .kpi-card { background: var(--card); border-radius: 16px; padding: 1.2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); text-align: center; border: 1px solid var(--border); position: relative; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px -3px rgba(0,0,0,0.15); }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--primary), var(--secondary)); }
        .kpi-card.success::before { background: linear-gradient(90deg, var(--success), #22c55e); }
        .kpi-card.danger::before { background: linear-gradient(90deg, var(--danger), #ef4444); }
        .kpi-card.accent::before { background: linear-gradient(90deg, var(--accent), #fbbf24); }
        .kpi-value { font-size: 2rem; font-weight: 700; color: var(--primary); margin: 0.5rem 0; }
        .kpi-card.success .kpi-value { color: var(--success); }
        .kpi-card.danger .kpi-value { color: var(--danger); }
        .kpi-card.accent .kpi-value { color: var(--accent); }
        .kpi-label { font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em; }
        .kpi-change { font-size: 0.8rem; font-weight: 600; margin-top: 0.3rem; }
        .kpi-change.positive { color: var(--success); }
        .kpi-change.negative { color: var(--danger); }
        .controls { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; padding: 1rem; background: var(--bg); border-radius: 12px; margin-bottom: 1rem; }
        .control-group { display: flex; align-items: center; gap: 0.5rem; }
        .control-label { font-size: 0.8rem; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.03em; }
        select, input[type="range"] { padding: 0.5rem 1rem; border: 2px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 0.85rem; cursor: pointer; background: white; transition: border-color 0.2s; }
        select:focus, input[type="range"]:focus { outline: none; border-color: var(--primary); }
        input[type="range"] { width: 200px; padding: 0.3rem; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; font-family: inherit; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.4rem; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .player-controls { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 8px; border: 2px solid var(--border); }
        .player-btn { width: 36px; height: 36px; border: none; border-radius: 50%; background: var(--primary); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .player-btn:hover { background: var(--secondary); }
        .player-btn.playing { background: var(--danger); }
        .year-display { font-size: 1.2rem; font-weight: 700; color: var(--primary); min-width: 60px; text-align: center; }
        .chart-container { position: relative; height: 400px; width: 100%; }
        .chart-container.tall { height: 500px; }
        .chart-container.short { height: 300px; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; }
        .intro-box { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid #bae6fd; }
        .intro-box h2 { color: var(--primary); margin-bottom: 0.8rem; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem; }
        .intro-box ul { margin-left: 1.5rem; margin-top: 0.5rem; }
        .intro-box li { margin-bottom: 0.3rem; }
        .hallazgo { background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); border-left: 4px solid var(--accent); padding: 1rem 1.2rem; margin: 1rem 0; border-radius: 0 12px 12px 0; }
        .hallazgo-title { font-weight: 600; color: var(--primary); margin-bottom: 0.3rem; display: flex; align-items: center; gap: 0.5rem; }
        .legend-custom { display: flex; gap: 1.5rem; flex-wrap: wrap; justify-content: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
        .legend-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.85rem; }
        .legend-color { width: 16px; height: 16px; border-radius: 4px; }
        .footer { background: var(--primary); color: white; text-align: center; padding: 2rem; margin-top: 2rem; }
        .footer a { color: var(--accent); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        .footer-grid { display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-bottom: 1rem; }
        .footer-item { text-align: center; }
        .footer-label { font-size: 0.7rem; opacity: 0.7; text-transform: uppercase; }
        .footer-value { font-weight: 600; }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.4rem; }
            .kpi-value { font-size: 1.6rem; }
            .chart-container { height: 300px; }
            .grid-2 { grid-template-columns: 1fr; }
            .controls { flex-direction: column; align-items: stretch; }
        }
        .heatmap-container { overflow-x: auto; }
        .heatmap-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .heatmap-table th, .heatmap-table td { padding: 0.4rem; text-align: center; border: 1px solid var(--border); }
        .heatmap-table th { background: var(--primary); color: white; font-weight: 600; position: sticky; top: 0; }
        .heatmap-table td { transition: all 0.2s; }
        .heatmap-table td:hover { transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 10; position: relative; }
        .heatmap-table .row-label { background: var(--bg); font-weight: 600; text-align: left; position: sticky; left: 0; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>üìä Mortalidad y Esperanza de Vida en la Comunitat Valenciana</h1>
            <div class="subtitle">An√°lisis Epidemiol√≥gico Interactivo | Per√≠odo 2010-2023</div>
            <div class="header-meta">
                <span class="badge">üìö Visualizaci√≥n de Datos - Parte II</span>
                <span class="badge accent">Enero 2026</span>
                <span class="badge">5.880 registros</span>
            </div>
        </div>
    </header>
    <nav class="nav">
        <div class="nav-container">
            <button class="nav-btn active" onclick="showSection('resumen')">üìã Resumen</button>
            <button class="nav-btn" onclick="showSection('temporal')">üìà Evoluci√≥n</button>
            <button class="nav-btn" onclick="showSection('causas')">üè• Causas</button>
            <button class="nav-btn" onclick="showSection('genero')">‚ö§ G√©nero</button>
            <button class="nav-btn" onclick="showSection('territorial')">üó∫Ô∏è Territorial</button>
            <button class="nav-btn" onclick="showSection('heatmap')">üî• Heatmap</button>
            <button class="nav-btn" onclick="showSection('covid')">ü¶† COVID-19</button>
            <button class="nav-btn" onclick="showSection('correlacion')">üìâ Correlaci√≥n</button>
        </div>
    </nav>
    <main class="container">
        <!-- RESUMEN -->
        <div id="resumen" class="section active">
            <div class="intro-box">
                <h2>üéØ Objetivos del An√°lisis</h2>
                <p>Este dashboard interactivo analiza <strong>5.880 registros</strong> del Portal Estad√≠stico de la Generalitat Valenciana, abarcando <strong>24 departamentos de salud</strong>, <strong>5 causas de mortalidad</strong> y desagregaci√≥n por sexo.</p>
                <ul>
                    <li>¬øC√≥mo ha evolucionado la mortalidad y cu√°l fue el impacto del COVID-19?</li>
                    <li>¬øCu√°l es la jerarqu√≠a de las principales causas de mortalidad?</li>
                    <li>¬øExisten diferencias significativas entre hombres y mujeres?</li>
                    <li>¬øQu√© disparidades territoriales existen entre departamentos?</li>
                    <li>¬øCu√°l es la tendencia del suicidio como problema de salud p√∫blica?</li>
                </ul>
            </div>
            <div class="kpi-grid">
                <div class="kpi-card success"><div class="kpi-label">Mortalidad 2023</div><div class="kpi-value">819.9</div><div class="kpi-change positive">‚Üì -4.3% vs 2010</div></div>
                <div class="kpi-card success"><div class="kpi-label">Esperanza Vida (65)</div><div class="kpi-value">21.5</div><div class="kpi-change positive">‚Üë +0.9 a√±os</div></div>
                <div class="kpi-card accent"><div class="kpi-label">Brecha G√©nero</div><div class="kpi-value">3.8</div><div class="kpi-change">a√±os (‚ôÄ > ‚ôÇ)</div></div>
                <div class="kpi-card danger"><div class="kpi-label">Exceso COVID</div><div class="kpi-value">+5.6%</div><div class="kpi-change negative">2020-2021</div></div>
                <div class="kpi-card danger"><div class="kpi-label">Tendencia Suicidio</div><div class="kpi-value">+11.2%</div><div class="kpi-change negative">√∫nica causa ‚Üë</div></div>
                <div class="kpi-card"><div class="kpi-label">Disparidad Territorial</div><div class="kpi-value">25%</div><div class="kpi-change">entre extremos</div></div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">üìà Evoluci√≥n General 2010-2023</div>
                        <div class="card-subtitle">Tendencia descendente con disrupci√≥n COVID-19 (2020-2021)</div>
                    </div>
                </div>
                <div class="chart-container"><canvas id="chartResumen"></canvas></div>
                <div class="legend-custom">
                    <div class="legend-item"><div class="legend-color" style="background: #3b82f6;"></div> Hombres</div>
                    <div class="legend-item"><div class="legend-color" style="background: #ec4899;"></div> Mujeres</div>
                    <div class="legend-item"><div class="legend-color" style="background: #8b5cf6;"></div> Ambos sexos</div>
                </div>
            </div>
        </div>
        <!-- TEMPORAL -->
        <div id="temporal" class="section">
            <div class="card">
                <div class="card-header"><div><div class="card-title">üìà Evoluci√≥n de la Mortalidad General</div><div class="card-subtitle">Comunitat Valenciana 2010-2023 | Tasa ajustada por edad</div></div></div>
                <div class="controls">
                    <div class="control-group"><span class="control-label">Sexo:</span><select id="selectSexoTemporal" onchange="updateTemporalChart()"><option value="todos">Todos</option><option value="hombres">Solo Hombres</option><option value="mujeres">Solo Mujeres</option><option value="ambos">Solo Ambos Sexos</option></select></div>
                    <div class="control-group"><span class="control-label">Rango:</span><select id="selectRangoTemporal" onchange="updateTemporalChart()"><option value="todos">2010-2023 (completo)</option><option value="pre">2010-2019 (Pre-COVID)</option><option value="post">2020-2023 (Post-COVID)</option></select></div>
                    <div class="control-group"><button class="btn btn-outline" onclick="exportData('temporal')">üì• Exportar CSV</button></div>
                </div>
                <div class="chart-container"><canvas id="chartTemporal"></canvas></div>
            </div>
            <div class="hallazgo"><div class="hallazgo-title">üí° Hallazgo Principal</div><p>La mortalidad general ha descendido un <strong>4.3%</strong> entre 2010 y 2023, alcanzando el <strong>m√≠nimo hist√≥rico de 819.9</strong> por 100.000 habitantes. El COVID-19 interrumpi√≥ temporalmente esta tendencia positiva con un pico del +5.6% en 2020-2021.</p></div>
        </div>
        <!-- CAUSAS -->
        <div id="causas" class="section">
            <div class="grid-2">
                <div class="card"><div class="card-header"><div><div class="card-title">üè• Jerarqu√≠a de Causas de Mortalidad</div><div class="card-subtitle">Tasa promedio 2010-2023</div></div></div><div class="chart-container"><canvas id="chartCausas"></canvas></div></div>
                <div class="card"><div class="card-header"><div><div class="card-title">üìâ Cambio Porcentual por Causa</div><div class="card-subtitle">Variaci√≥n 2010-2023</div></div></div><div class="chart-container"><canvas id="chartTendenciaCausas"></canvas></div></div>
            </div>
            <div class="card">
                <div class="card-header"><div><div class="card-title">‚ö†Ô∏è Tendencia del Suicidio - Se√±al de Alarma</div><div class="card-subtitle">√önica causa con tendencia ascendente (+11.2%)</div></div>
                    
                </div>
                <div class="chart-container short"><canvas id="chartSuicidio"></canvas></div>
            </div>
            <div class="hallazgo"><div class="hallazgo-title">üí° Hallazgo Principal</div><p>El <strong>c√°ncer domina</strong> con 228.8/100.000. Mientras las causas cardiovasculares han descendido (-22 a -24%), <strong>el suicidio es la √∫nica causa que aumenta (+11.2%)</strong>.</p></div>
        </div>
        <!-- G√âNERO -->
        <div id="genero" class="section">
            <div class="grid-2">
                <div class="card"><div class="card-header"><div><div class="card-title">‚ö§ Ratio de Mortalidad Hombres/Mujeres</div><div class="card-subtitle">Los hombres mueren m√°s en TODAS las causas</div></div></div><div class="chart-container"><canvas id="chartRatioGenero"></canvas></div></div>
                <div class="card"><div class="card-header"><div><div class="card-title">üìä Tasas Absolutas por Sexo y Causa</div><div class="card-subtitle">Comparativa directa</div></div></div>
                    <div class="controls"><div class="control-group"><span class="control-label">Causa:</span><select id="selectCausaGenero" onchange="updateGeneroChart()"><option value="todas">Todas las causas</option><option value="cancer">C√°ncer</option><option value="cardio">Cardiopat√≠a Isqu√©mica</option><option value="cerebro">Enf. Cerebrovascular</option><option value="suicidio">Suicidio</option></select></div></div>
                    <div class="chart-container"><canvas id="chartGeneroBarras"></canvas></div>
                </div>
            </div>
            <div class="card"><div class="card-header"><div><div class="card-title">üìà Esperanza de Vida a los 65 a√±os por Sexo</div><div class="card-subtitle">Brecha persistente de ~4 a√±os</div></div></div><div class="chart-container short"><canvas id="chartEVGenero"></canvas></div></div>
            <div class="hallazgo"><div class="hallazgo-title">üí° Hallazgo Principal</div><p>Los hombres presentan tasas de mortalidad superiores: <strong>3.1x en suicidio</strong>, 2.3x en cardiopat√≠a. Las mujeres viven <strong>3.8 a√±os m√°s</strong> a partir de los 65 a√±os.</p></div>
        </div>
        <!-- TERRITORIAL -->
        <div id="territorial" class="section">
            <div class="card">
                <div class="card-header"><div><div class="card-title">üó∫Ô∏è Ranking de Departamentos de Salud</div><div class="card-subtitle">Tasa de mortalidad promedio 2010-2023 | Disparidad del 25% entre extremos</div></div></div>
                <div class="controls">
                    <div class="control-group"><span class="control-label">Provincia:</span><select id="selectProvincia" onchange="updateDepartamentosChart()"><option value="todas">Todas</option><option value="Alicante">Alicante</option><option value="Valencia">Valencia</option><option value="Castell√≥n">Castell√≥n</option></select></div>
                    <div class="control-group"><span class="control-label">Ordenar:</span><select id="selectOrden" onchange="updateDepartamentosChart()"><option value="asc">Menor a Mayor</option><option value="desc">Mayor a Menor</option></select></div>
                    <div class="control-group"><button class="btn btn-outline" onclick="exportData('departamentos')">üì• Exportar CSV</button></div>
                </div>
                <div class="chart-container tall"><canvas id="chartDepartamentos"></canvas></div>
                <div class="legend-custom">
                    <div class="legend-item"><div class="legend-color" style="background: #16a34a;"></div> Alicante</div>
                    <div class="legend-item"><div class="legend-color" style="background: #3b82f6;"></div> Valencia</div>
                    <div class="legend-item"><div class="legend-color" style="background: #eab308;"></div> Castell√≥n</div>
                    <div class="legend-item" style="margin-left: 1rem;"><span style="color: var(--danger); font-weight: 600;">---|</span> Media CV: 876</div>
                </div>
            </div>
            <div class="card"><div class="card-header"><div><div class="card-title">üìä Comparativa por Provincias</div><div class="card-subtitle">Evoluci√≥n temporal 2010-2023</div></div></div><div class="chart-container short"><canvas id="chartProvincias"></canvas></div></div>
            <div class="hallazgo"><div class="hallazgo-title">üí° Hallazgo Principal</div><p>Existe una <strong>variabilidad del 25%</strong> entre Ribera (975.2) y Doctor Peset (783.1). Las disparidades son <strong>estructurales y persistentes</strong>.</p></div>
        </div>
        <!-- HEATMAP -->
        <div id="heatmap" class="section">
            <div class="card">
                <div class="card-header"><div><div class="card-title">üî• Mapa de Calor: Mortalidad por Departamento y A√±o</div><div class="card-subtitle">Rojo = Mayor mortalidad | Verde = Menor mortalidad</div></div><button class="btn btn-outline" onclick="exportData('heatmap')">üì• Exportar CSV</button></div>
                <div class="heatmap-container"><table class="heatmap-table" id="heatmapTable"></table></div>
            </div>
            <div class="hallazgo"><div class="hallazgo-title">üí° Hallazgo Principal</div><p>El heatmap revela patrones <strong>estructurales y persistentes</strong>: los departamentos mantienen su posici√≥n relativa durante los 14 a√±os. 2020-2021 muestran mayor mortalidad por COVID-19.</p></div>
        </div>
        <!-- COVID -->
        <div id="covid" class="section">
            <div class="grid-2">
                <div class="card"><div class="card-header"><div><div class="card-title">ü¶† Impacto COVID-19 - Valores Absolutos</div><div class="card-subtitle">Comparativa por per√≠odo</div></div></div><div class="chart-container"><canvas id="chartCovidAbsoluto"></canvas></div></div>
                <div class="card"><div class="card-header"><div><div class="card-title">üìä Exceso de Mortalidad</div><div class="card-subtitle">Variaci√≥n % respecto a Pre-COVID</div></div></div><div class="chart-container"><canvas id="chartCovidRelativo"></canvas></div></div>
            </div>
            <div class="card"><div class="card-header"><div><div class="card-title">üìà Impacto COVID por Sexo</div></div></div><div class="chart-container short"><canvas id="chartCovidSexo"></canvas></div></div>
            <div class="hallazgo"><div class="hallazgo-title">üí° Hallazgo Principal</div><p>El COVID-19 gener√≥ un exceso de mortalidad del <strong>5.3% en 2020</strong> y <strong>5.9% en 2021</strong>. La recuperaci√≥n en 2022-2023 ha sido completa.</p></div>
        </div>
        <!-- CORRELACI√ìN -->
        <div id="correlacion" class="section">
            <div class="card">
                <div class="card-header"><div><div class="card-title">üìâ Correlaci√≥n: Mortalidad vs Esperanza de Vida</div><div class="card-subtitle">672 observaciones | Departamento √ó A√±o √ó Sexo</div></div></div>
                <div class="controls">
                    <div class="control-group"><span class="control-label">Sexo:</span><select id="selectCorrelacion" onchange="updateCorrelacionChart()"><option value="todos">Ambos</option><option value="hombres">Solo Hombres</option><option value="mujeres">Solo Mujeres</option></select></div>
                    <div class="control-group"><span class="control-label">A√±o:</span><select id="selectAnoCorrelacion" onchange="updateCorrelacionChart()"><option value="todos">Todos (2010-2023)</option><option value="2010">2010</option><option value="2015">2015</option><option value="2019">2019</option><option value="2020">2020 (COVID)</option><option value="2021">2021 (COVID)</option><option value="2023">2023</option></select></div>
                    <div class="control-group"><span class="control-label">Provincia:</span><select id="selectProvCorrelacion" onchange="updateCorrelacionChart()"><option value="todas">Todas</option><option value="Alicante">Alicante</option><option value="Castell√≥n">Castell√≥n</option><option value="Valencia">Valencia</option></select></div>
                </div>
                <div class="chart-container tall"><canvas id="chartCorrelacion"></canvas></div>
                <div style="text-align: center; margin-top: 1rem; padding: 1rem; background: var(--bg); border-radius: 8px;"><strong>Correlaci√≥n de Pearson: r = -0.983</strong> (p < 0.001)</div>
            </div>
            <div class="hallazgo"><div class="hallazgo-title">üí° Hallazgo Principal</div><p>Existe una <strong>correlaci√≥n negativa casi perfecta (r = -0.983)</strong>. Se observan <strong>dos nubes claramente separadas</strong> por sexo sin solapamiento.</p></div>
        </div>
    </main>
    <footer class="footer">
        <div class="footer-grid">
            <div class="footer-item"><div class="footer-label">Autor</div><div class="footer-value">Crist√≥bal E. Aguilar Gallardo</div></div>
            <div class="footer-item"><div class="footer-label">Fuente</div><div class="footer-value"><a href="https://pegv.gva.es/" target="_blank">Portal Estad√≠stico GVA</a></div></div>
            <div class="footer-item"><div class="footer-label">Registros</div><div class="footer-value">5.880</div></div>
            <div class="footer-item"><div class="footer-label">Per√≠odo</div><div class="footer-value">2010-2023</div></div>
        </div>
        <p style="opacity: 0.8;">Visualizaci√≥n de Datos - Parte II | Enero 2026</p>
    </footer>
    <script>
        const a√±os = [2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023];
        const datosTemporales = {
            ambos: [857.16, 845.74, 857.60, 843.53, 822.75, 852.28, 836.43, 847.85, 851.95, 862.20, 902.61, 907.83, 877.91, 819.88],
            hombres: [1007.30, 991.23, 1000.65, 983.77, 958.41, 993.93, 974.79, 987.85, 993.87, 1003.30, 1054.57, 1062.28, 1025.12, 955.50],
            mujeres: [731.05, 722.99, 736.46, 725.24, 708.56, 732.43, 718.79, 728.61, 731.10, 741.74, 771.68, 774.71, 751.18, 703.35]
        };
        const evPorSexo = {
            hombres: [18.9, 19.1, 19.0, 19.2, 19.4, 19.3, 19.5, 19.4, 19.4, 19.3, 18.8, 18.8, 19.1, 19.6],
            mujeres: [22.8, 23.0, 22.9, 23.1, 23.3, 23.1, 23.3, 23.2, 23.2, 23.1, 22.7, 22.6, 22.9, 23.4]
        };
        const suicidioData = {
            ambos: [7.02, 6.14, 7.21, 7.45, 7.38, 7.65, 7.12, 7.34, 7.89, 7.45, 7.12, 8.01, 7.95, 7.81],
            hombres: [11.5, 10.2, 11.8, 12.1, 11.9, 12.4, 11.5, 11.9, 12.8, 12.1, 11.5, 13.0, 12.9, 12.7],
            mujeres: [3.1, 2.5, 3.1, 3.3, 3.3, 3.4, 3.2, 3.2, 3.5, 3.2, 3.1, 3.5, 3.5, 3.4]
        };
        const causas = { nombres: ['C√°ncer', 'Cardiopat√≠a Isqu√©mica', 'Enf. Cerebrovascular', 'Suicidio'], tasas: [228.8, 68.5, 46.2, 7.8], colores: ['#ef4444', '#f97316', '#eab308', '#8b5cf6'], cambios: [-1.2, -24.0, -22.8, 11.2] };
        const ratioGenero = { causas: ['Suicidio', 'Cardiopat√≠a Isqu√©mica', 'C√°ncer', 'Mortalidad General', 'Enf. Cerebrovascular'], ratios: [3.11, 2.29, 2.08, 1.58, 1.22], colores: ['#dc2626', '#ea580c', '#f59e0b', '#84cc16', '#22c55e'] };
        const tasasPorSexoCausa = { cancer: { h: 307.5, m: 161.2 }, cardio: { h: 95.8, m: 45.6 }, cerebro: { h: 51.2, m: 42.1 }, suicidio: { h: 12.1, m: 3.9 } };
        
        // DATOS CORREGIDOS - Coinciden con el heatmap
        const departamentos = {
            nombres: ['Doctor Peset', 'Torrevieja', 'Elx Hospital General', 'Cl√≠nic Malvarrosa', 'Alacant Hospital General', 'Valencia La Fe', 'Marina Baixa', 'Vinar√≥s', 'Castell√≥', 'Sant Joan', 'D√©nia', 'Elda', 'Alcoi', 'Valencia Hospital General', 'La Plana', 'Elx-Crevillent', 'Requena', 'Orihuela', 'Sagunt', 'Vilanova', 'Gandia', 'Manises', 'X√†tiva-Ontinyent', 'Ribera'],
            tasas: [783.1, 794.4, 805.9, 825.9, 835.7, 836.2, 837.9, 849.0, 849.6, 850.3, 877.0, 881.0, 885.2, 893.3, 902.2, 911.6, 912.4, 914.6, 916.7, 935.0, 937.5, 937.9, 938.3, 975.2],
            provincias: ['Valencia', 'Alicante', 'Alicante', 'Valencia', 'Alicante', 'Valencia', 'Alicante', 'Castell√≥n', 'Castell√≥n', 'Alicante', 'Alicante', 'Alicante', 'Alicante', 'Valencia', 'Castell√≥n', 'Alicante', 'Valencia', 'Alicante', 'Valencia', 'Valencia', 'Valencia', 'Valencia', 'Valencia', 'Valencia']
        };
        
        const provinciasData = { alicante: [842, 831, 845, 830, 810, 838, 822, 833, 837, 848, 888, 893, 863, 805], valencia: [872, 860, 872, 858, 837, 867, 851, 862, 867, 878, 918, 923, 893, 835], castellon: [858, 846, 860, 845, 825, 853, 837, 848, 853, 864, 904, 909, 879, 821] };
        
        const heatmapData = {
            "Ribera": [998.2, 1009.3, 1038.6, 937.8, 954.9, 1005.2, 963.7, 958.8, 979.3, 916.6, 946.2, 1001.8, 1003.1, 939.1],
            "X√†tiva-Ontinyent": [1002.1, 957.2, 1029.4, 879.7, 873.3, 987.2, 913.7, 973.9, 938.8, 891.3, 968.7, 917.2, 930.3, 873.7],
            "Manises": [945.4, 935.9, 1010.0, 873.2, 912.8, 1000.1, 919.8, 989.8, 928.2, 861.3, 955.1, 950.6, 964.4, 883.7],
            "Gandia": [921.6, 929.2, 979.8, 920.6, 898.7, 994.1, 960.9, 977.7, 917.9, 877.0, 980.2, 968.4, 944.4, 855.0],
            "Vilanova": [947.7, 921.2, 998.6, 927.3, 934.5, 997.3, 927.0, 970.0, 936.1, 911.8, 942.2, 896.0, 939.3, 841.0],
            "Sagunt": [892.3, 916.5, 944.6, 907.9, 863.0, 935.8, 899.7, 917.1, 959.4, 872.4, 951.8, 946.2, 929.8, 897.2],
            "Orihuela": [996.0, 1021.5, 907.7, 880.8, 852.9, 964.8, 853.2, 862.8, 967.0, 934.8, 901.5, 912.3, 917.0, 832.2],
            "Requena": [1035.4, 985.0, 899.7, 876.4, 942.0, 908.4, 841.3, 882.1, 846.8, 899.6, 1003.4, 847.6, 905.3, 900.2],
            "Elx-Crevillent": [1089.7, 896.2, 1000.9, 921.0, 844.9, 953.0, 838.8, 864.6, 967.0, 830.3, 891.4, 936.2, 950.2, 778.4],
            "La Plana": [947.2, 964.4, 913.1, 878.4, 906.0, 936.8, 882.7, 871.1, 953.5, 834.5, 896.7, 929.7, 904.5, 812.1],
            "Valencia Hospital General": [921.4, 919.5, 916.7, 883.1, 897.0, 910.8, 892.4, 890.5, 897.6, 816.1, 913.8, 896.7, 925.8, 824.2],
            "Alcoi": [932.2, 908.6, 980.7, 907.4, 885.5, 946.1, 831.0, 893.5, 877.6, 751.8, 894.5, 921.1, 879.5, 783.2],
            "Elda": [926.3, 867.4, 979.5, 846.6, 872.3, 926.7, 863.2, 867.4, 894.6, 816.7, 918.3, 872.4, 872.2, 810.1],
            "D√©nia": [871.0, 830.3, 953.8, 861.8, 877.8, 927.3, 895.5, 948.4, 912.5, 863.9, 876.9, 886.8, 793.4, 779.0],
            "Sant Joan": [814.8, 830.1, 878.1, 873.8, 851.6, 917.2, 823.3, 908.9, 874.8, 800.6, 877.4, 885.8, 803.0, 764.8],
            "Castell√≥": [859.4, 838.5, 871.6, 859.7, 854.6, 929.6, 861.5, 862.3, 857.1, 801.9, 834.5, 853.6, 833.1, 777.2],
            "Vinar√≥s": [884.0, 898.8, 889.6, 866.7, 861.8, 902.9, 803.6, 845.0, 932.6, 786.2, 798.4, 838.3, 773.5, 804.9],
            "Marina Baixa": [798.6, 796.0, 938.8, 837.0, 829.6, 882.9, 857.0, 916.3, 868.9, 743.2, 842.4, 878.6, 788.3, 753.5],
            "Valencia La Fe": [919.2, 862.6, 873.6, 833.5, 847.3, 880.7, 857.6, 845.0, 809.4, 765.4, 824.1, 808.9, 819.8, 760.3],
            "Alacant Hospital General": [896.5, 944.0, 914.3, 820.0, 877.4, 893.0, 846.4, 830.7, 803.8, 735.7, 801.2, 799.9, 787.2, 750.3],
            "Cl√≠nic Malvarrosa": [908.5, 853.0, 871.0, 823.2, 843.4, 856.2, 811.7, 850.4, 822.2, 744.8, 819.8, 825.5, 813.0, 719.3],
            "Elx Hospital General": [794.6, 826.7, 882.7, 839.6, 797.5, 856.7, 818.3, 800.0, 831.0, 766.5, 743.5, 825.2, 776.4, 723.4],
            "Torrevieja": [649.2, 631.1, 797.7, 742.5, 781.6, 786.6, 767.2, 879.6, 840.5, 765.7, 880.6, 939.3, 839.6, 819.8],
            "Doctor Peset": [883.2, 920.9, 820.3, 765.7, 771.2, 815.2, 730.9, 773.3, 747.1, 703.5, 799.8, 773.9, 747.0, 711.7],
        };
        const covidData = { periodos: ['Pre-COVID', '2020', '2021', 'Post-COVID'], valores: [857.1, 902.6, 907.8, 848.9], variaciones: [0, 5.3, 5.9, -1.0] };
        
        // Scatter data simplificado
        const scatterData = {
            hombres: [{x: 1100, y: 18.5, a√±o: 2010, dept: "Promedio", prov: "CV"}, {x: 1050, y: 19.0, a√±o: 2015, dept: "Promedio", prov: "CV"}, {x: 1060, y: 18.8, a√±o: 2020, dept: "Promedio", prov: "CV"}, {x: 955, y: 19.6, a√±o: 2023, dept: "Promedio", prov: "CV"}],
            mujeres: [{x: 730, y: 22.8, a√±o: 2010, dept: "Promedio", prov: "CV"}, {x: 720, y: 23.1, a√±o: 2015, dept: "Promedio", prov: "CV"}, {x: 770, y: 22.7, a√±o: 2020, dept: "Promedio", prov: "CV"}, {x: 703, y: 23.4, a√±o: 2023, dept: "Promedio", prov: "CV"}]
        };
        
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#64748b';
        let charts = {};
      
        
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }
        
        function toggleAnimation(type) {
            const btn = document.getElementById('playBtnSuicidio');
            const slider = document.getElementById('sliderSuicidio');
            if (animations[type]) {
                clearInterval(animations[type]); animations[type] = null;
                btn.innerHTML = '‚ñ∂'; btn.classList.remove('playing');
            } else {
                let year = 2010; slider.value = 2010;
                btn.innerHTML = '‚è∏'; btn.classList.add('playing');
                animations[type] = setInterval(() => {
                    year++; if (year > 2023) year = 2010;
                    slider.value = year;
                    document.getElementById('yearDisplaySuicidio').textContent = year;
                }, 800);
            }
        }
       
        
        function exportData(type) {
            let csv = '', filename = '';
            if (type === 'temporal') {
                csv = 'A√±o,Ambos Sexos,Hombres,Mujeres\n';
                a√±os.forEach((a√±o, i) => { csv += `${a√±o},${datosTemporales.ambos[i]},${datosTemporales.hombres[i]},${datosTemporales.mujeres[i]}\n`; });
                filename = 'mortalidad_temporal_cv.csv';
            } else if (type === 'departamentos') {
                csv = 'Departamento,Provincia,Tasa Mortalidad\n';
                departamentos.nombres.forEach((n, i) => { csv += `"${n}",${departamentos.provincias[i]},${departamentos.tasas[i]}\n`; });
                filename = 'mortalidad_departamentos_cv.csv';
            } else if (type === 'heatmap') {
                csv = 'Departamento,' + a√±os.join(',') + '\n';
                Object.keys(heatmapData).forEach(d => { csv += `"${d}",${heatmapData[d].join(',')}\n`; });
                filename = 'heatmap_mortalidad_cv.csv';
            }
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = filename; link.click();
        }
        
        function createChartResumen() {
            charts.resumen = new Chart(document.getElementById('chartResumen'), {
                type: 'line',
                data: {
                    labels: a√±os,
                    datasets: [
                        { label: 'Hombres', data: datosTemporales.hombres, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: false, tension: 0.3, pointRadius: 5 },
                        { label: 'Mujeres', data: datosTemporales.mujeres, borderColor: '#ec4899', backgroundColor: 'rgba(236, 72, 153, 0.1)', fill: false, tension: 0.3, pointRadius: 5 },
                        { label: 'Ambos sexos', data: datosTemporales.ambos, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.15)', fill: true, tension: 0.3, pointRadius: 5, borderWidth: 3 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, interaction: { intersect: false, mode: 'index' }, plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(30, 58, 95, 0.95)', callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}` } } }, scales: { y: { title: { display: true, text: 'Tasa por 100.000 hab.' }, min: 650, max: 1100 }, x: { title: { display: true, text: 'A√±o' } } } }
            });
        }
        
        function createChartTemporal() {
            charts.temporal = new Chart(document.getElementById('chartTemporal'), {
                type: 'line', data: { labels: a√±os, datasets: [
                    { label: 'Hombres', data: datosTemporales.hombres, borderColor: '#3b82f6', tension: 0.3, pointRadius: 5 },
                    { label: 'Mujeres', data: datosTemporales.mujeres, borderColor: '#ec4899', tension: 0.3, pointRadius: 5 },
                    { label: 'Ambos sexos', data: datosTemporales.ambos, borderColor: '#8b5cf6', fill: true, tension: 0.3, pointRadius: 5, borderWidth: 3 }
                ]}, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { title: { display: true, text: 'Tasa por 100.000' }, min: 650, max: 1100 } } }
            });
        }
        function updateTemporalChart() {
            const sexo = document.getElementById('selectSexoTemporal').value;
            const rango = document.getElementById('selectRangoTemporal').value;
            charts.temporal.data.datasets.forEach((ds, i) => {
                if (sexo === 'todos') ds.hidden = false;
                else if (sexo === 'hombres') ds.hidden = i !== 0;
                else if (sexo === 'mujeres') ds.hidden = i !== 1;
                else if (sexo === 'ambos') ds.hidden = i !== 2;
            });
            let startIdx = 0, endIdx = a√±os.length;
            if (rango === 'pre') endIdx = 10;
            else if (rango === 'post') startIdx = 10;
            charts.temporal.data.labels = a√±os.slice(startIdx, endIdx);
            charts.temporal.data.datasets[0].data = datosTemporales.hombres.slice(startIdx, endIdx);
            charts.temporal.data.datasets[1].data = datosTemporales.mujeres.slice(startIdx, endIdx);
            charts.temporal.data.datasets[2].data = datosTemporales.ambos.slice(startIdx, endIdx);
            charts.temporal.update();
        }
        
        function createChartCausas() {
            charts.causas = new Chart(document.getElementById('chartCausas'), { type: 'bar', data: { labels: causas.nombres, datasets: [{ data: causas.tasas, backgroundColor: causas.colores, borderRadius: 8 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { title: { display: true, text: 'Tasa por 100.000' } } } } });
        }
        function createChartTendenciaCausas() {
            charts.tendenciaCausas = new Chart(document.getElementById('chartTendenciaCausas'), { type: 'bar', data: { labels: causas.nombres, datasets: [{ data: causas.cambios, backgroundColor: causas.cambios.map(v => v > 0 ? '#dc2626' : '#16a34a'), borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.parsed.y > 0 ? '+' : ''}${ctx.parsed.y.toFixed(1)}%` } } }, scales: { y: { title: { display: true, text: 'Cambio %' } } } } });
        }
        function createChartSuicidio() {
            charts.suicidio = new Chart(document.getElementById('chartSuicidio'), { type: 'line', data: { labels: a√±os, datasets: [{ label: 'Hombres', data: suicidioData.hombres, borderColor: '#3b82f6', tension: 0.3 }, { label: 'Mujeres', data: suicidioData.mujeres, borderColor: '#ec4899', tension: 0.3 }, { label: 'Ambos', data: suicidioData.ambos, borderColor: '#8b5cf6', borderWidth: 3, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { title: { display: true, text: 'Tasa por 100.000' }, min: 0, max: 15 } } } });
        }
        function createChartRatioGenero() {
            charts.ratioGenero = new Chart(document.getElementById('chartRatioGenero'), { type: 'bar', data: { labels: ratioGenero.causas, datasets: [{ data: ratioGenero.ratios, backgroundColor: ratioGenero.colores, borderRadius: 8 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.parsed.x.toFixed(2)}x m√°s en hombres` } } }, scales: { x: { title: { display: true, text: 'Ratio H/M' }, min: 0, max: 3.5 } } } });
        }
        function createChartGeneroBarras() {
            charts.generoBarras = new Chart(document.getElementById('chartGeneroBarras'), { type: 'bar', data: { labels: ['C√°ncer', 'Cardiopat√≠a', 'Cerebrovascular', 'Suicidio'], datasets: [{ label: 'Hombres', data: [307.5, 95.8, 51.2, 12.1], backgroundColor: '#3b82f6', borderRadius: 6 }, { label: 'Mujeres', data: [161.2, 45.6, 42.1, 3.9], backgroundColor: '#ec4899', borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { title: { display: true, text: 'Tasa por 100.000' } } } } });
        }
        function updateGeneroChart() {
            const causa = document.getElementById('selectCausaGenero').value;
            let labels, dataH, dataM;
            if (causa === 'todas') { labels = ['C√°ncer', 'Cardiopat√≠a', 'Cerebrovascular', 'Suicidio']; dataH = [307.5, 95.8, 51.2, 12.1]; dataM = [161.2, 45.6, 42.1, 3.9]; }
            else { const d = tasasPorSexoCausa[causa]; labels = [causa]; dataH = [d.h]; dataM = [d.m]; }
            charts.generoBarras.data.labels = labels;
            charts.generoBarras.data.datasets[0].data = dataH;
            charts.generoBarras.data.datasets[1].data = dataM;
            charts.generoBarras.update();
        }
        function createChartEVGenero() {
            charts.evGenero = new Chart(document.getElementById('chartEVGenero'), { type: 'line', data: { labels: a√±os, datasets: [{ label: 'Mujeres', data: evPorSexo.mujeres, borderColor: '#ec4899', fill: true, tension: 0.3 }, { label: 'Hombres', data: evPorSexo.hombres, borderColor: '#3b82f6', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { title: { display: true, text: 'A√±os' }, min: 17, max: 25 } } } });
        }
        function createChartDepartamentos() {
            const colores = departamentos.provincias.map(p => p === 'Alicante' ? '#16a34a' : p === 'Valencia' ? '#3b82f6' : '#eab308');
            charts.departamentos = new Chart(document.getElementById('chartDepartamentos'), { type: 'bar', data: { labels: departamentos.nombres, datasets: [{ data: departamentos.tasas, backgroundColor: colores, borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { afterLabel: ctx => `Provincia: ${departamentos.provincias[ctx.dataIndex]}` } } }, scales: { x: { title: { display: true, text: 'Tasa por 100.000' }, min: 750, max: 1000 } } } });
        }
        function updateDepartamentosChart() {
            const provincia = document.getElementById('selectProvincia').value;
            const orden = document.getElementById('selectOrden').value;
            let indices = [...Array(departamentos.nombres.length).keys()];
            if (provincia !== 'todas') indices = indices.filter(i => departamentos.provincias[i] === provincia);
            if (orden === 'desc') indices.sort((a, b) => departamentos.tasas[b] - departamentos.tasas[a]);
            else indices.sort((a, b) => departamentos.tasas[a] - departamentos.tasas[b]);
            charts.departamentos.data.labels = indices.map(i => departamentos.nombres[i]);
            charts.departamentos.data.datasets[0].data = indices.map(i => departamentos.tasas[i]);
            charts.departamentos.data.datasets[0].backgroundColor = indices.map(i => departamentos.provincias[i] === 'Alicante' ? '#16a34a' : departamentos.provincias[i] === 'Valencia' ? '#3b82f6' : '#eab308');
            charts.departamentos.update();
        }
        function createChartProvincias() {
            charts.provincias = new Chart(document.getElementById('chartProvincias'), { type: 'line', data: { labels: a√±os, datasets: [{ label: 'Alicante', data: provinciasData.alicante, borderColor: '#16a34a', tension: 0.3 }, { label: 'Valencia', data: provinciasData.valencia, borderColor: '#3b82f6', tension: 0.3 }, { label: 'Castell√≥n', data: provinciasData.castellon, borderColor: '#eab308', tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { title: { display: true, text: 'Tasa por 100.000' } } } } });
        }
        function generateHeatmap() {
            const table = document.getElementById('heatmapTable');
            let html = '<tr><th>Departamento</th>';
            a√±os.forEach(a√±o => { html += `<th style="${(a√±o === 2020 || a√±o === 2021) ? 'background: #dc2626;' : ''}">${a√±o}</th>`; });
            html += '</tr>';
            const deptOrder = Object.keys(heatmapData).sort((a, b) => {
                const avgA = heatmapData[a].reduce((s, v) => s + v, 0) / heatmapData[a].length;
                const avgB = heatmapData[b].reduce((s, v) => s + v, 0) / heatmapData[b].length;
                return avgB - avgA;
            });
            const allValues = Object.values(heatmapData).flat();
            const minVal = Math.min(...allValues), maxVal = Math.max(...allValues);
            deptOrder.forEach(dept => {
                html += `<tr><td class="row-label">${dept}</td>`;
                heatmapData[dept].forEach(val => {
                    const ratio = (val - minVal) / (maxVal - minVal);
                    const r = Math.round(220 * ratio + 35), g = Math.round(180 * (1 - ratio) + 75), b = Math.round(80 * (1 - ratio) + 50);
                    html += `<td style="background: rgb(${r},${g},${b}); color: ${ratio > 0.5 ? 'white' : 'black'};" title="${dept}: ${val}">${val}</td>`;
                });
                html += '</tr>';
            });
            table.innerHTML = html;
        }
        function createChartCovidAbsoluto() { charts.covidAbsoluto = new Chart(document.getElementById('chartCovidAbsoluto'), { type: 'bar', data: { labels: covidData.periodos, datasets: [{ data: covidData.valores, backgroundColor: ['#16a34a', '#dc2626', '#dc2626', '#3b82f6'], borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { title: { display: true, text: 'Tasa por 100.000' }, min: 800, max: 950 } } } }); }
        function createChartCovidRelativo() { charts.covidRelativo = new Chart(document.getElementById('chartCovidRelativo'), { type: 'bar', data: { labels: covidData.periodos, datasets: [{ data: covidData.variaciones, backgroundColor: ['#64748b', '#dc2626', '#dc2626', '#3b82f6'], borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.parsed.y > 0 ? '+' : ''}${ctx.parsed.y.toFixed(1)}%` } } }, scales: { y: { title: { display: true, text: 'Variaci√≥n %' }, min: -2, max: 7 } } } }); }
        function createChartCovidSexo() { charts.covidSexo = new Chart(document.getElementById('chartCovidSexo'), { type: 'line', data: { labels: ['2018', '2019', '2020', '2021', '2022', '2023'], datasets: [{ label: 'Hombres', data: [993.9, 1003.3, 1054.6, 1062.3, 1025.1, 955.5], borderColor: '#3b82f6', tension: 0.3 }, { label: 'Mujeres', data: [731.1, 741.7, 771.7, 774.7, 751.2, 703.4], borderColor: '#ec4899', tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { title: { display: true, text: 'Tasa por 100.000' } } } } }); }
       function createChartCorrelacion() {
    charts.correlacion = new Chart(document.getElementById('chartCorrelacion'), {
        type: 'scatter',
        data: {
            datasets: [
                { label: 'Hombres', data: [], backgroundColor: 'rgba(59, 130, 246, 0.6)', borderColor: '#3b82f6', pointRadius: 8 },
                { label: 'Mujeres', data: [], backgroundColor: 'rgba(236, 72, 153, 0.6)', borderColor: '#ec4899', pointRadius: 8 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            const d = ctx.raw;
                            return [`A√±o: ${d.a√±o}`, `Mortalidad: ${d.x}`, `EV: ${d.y} a√±os`];
                        }
                    }
                }
            },
            scales: {
                x: { title: { display: true, text: 'Tasa de Mortalidad' }, min: 650, max: 1150 },
                y: { title: { display: true, text: 'Esperanza de Vida (a√±os)' }, min: 17, max: 25 }
            }
        }
    });
    updateCorrelacionChart(); // Esto carga los datos iniciales
}

function updateCorrelacionChart() {
    const sexo = document.getElementById('selectCorrelacion').value;
    const a√±o = document.getElementById('selectAnoCorrelacion').value;
    const provincia = document.getElementById('selectProvCorrelacion').value;

    // Funci√≥n interna para filtrar
    const filtrar = (lista) => lista.filter(d => {
        const matchA√±o = (a√±o === 'todos') || (d.a√±o === parseInt(a√±o));
        const matchProv = (provincia === 'todas') || (d.prov === provincia);
        return matchA√±o && matchProv;
    });

    const datosH = (sexo === 'todos' || sexo === 'hombres') ? filtrar(scatterData.hombres) : [];
    const datosM = (sexo === 'todos' || sexo === 'mujeres') ? filtrar(scatterData.mujeres) : [];

    charts.correlacion.data.datasets[0].data = datosH;
    charts.correlacion.data.datasets[1].data = datosM;
    
    // Ocultar el dataset si no hay datos para que no ensucie la leyenda
    charts.correlacion.data.datasets[0].hidden = datosH.length === 0;
    charts.correlacion.data.datasets[1].hidden = datosM.length === 0;

    charts.correlacion.update();
}
        
        document.addEventListener('DOMContentLoaded', function() {
            createChartResumen(); createChartTemporal(); createChartCausas(); createChartTendenciaCausas();
            createChartSuicidio(); createChartRatioGenero(); createChartGeneroBarras(); createChartEVGenero();
            createChartDepartamentos(); createChartProvincias(); createChartCovidAbsoluto();
            createChartCovidRelativo(); createChartCovidSexo(); createChartCorrelacion(); generateHeatmap();
        });
    </script>
</body>
</html>
